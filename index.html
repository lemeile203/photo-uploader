<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‹¤ì²œ ëª©í‘œ ì •í•˜ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/cropperjs"></script>
  <link rel="stylesheet" href="https://unpkg.com/cropperjs/dist/cropper.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #f4f4f4;
      text-align: center;
      padding: 20px;
    }

    h2 {
      color: #333;
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
#options label {
   font-size: 1.1rem;    /* å­—å·ä¿æŒä¸å˜æˆ–å¯è°ƒå°ä¸º 1rem */
  line-height: 1.2;     /* è¡Œé«˜ï¼ˆé€‰é¡¹æ–‡æœ¬æœ¬èº«çš„è¡Œè·ï¼‰å‡å° */
  display: block;       
  margin-bottom: 4px;      /* æ¯ä¸ªé€‰é¡¹é—´è· */
}
    #preview {
  width: 90vw;
  max-width: 300px;
  height: 350px;
  border: 1px solid #ccc;
  background-color: #fff;
  margin-top: 25px;
    }

    input[type="file"] {
      display: none;
    }

    /* ğŸ“· ç°è‰²æŒ‰é’® */
    .gray-btn {
      margin-top: 15px;
      background-color: #ccc;
      color: #333;
      border: none;
      padding: 8px 12px;
      font-size: 1rem;
      border-radius: 6px;
      cursor: pointer;
    }

    .gray-btn:hover {
      background-color: #bbb;
    }

    /* ğŸ“¤ è“è‰²æŒ‰é’® */
    .blue-btn {
      margin-top: 20px;
      background-color: #007BFF;
      color: white;
      border: none;
      padding: 8px 25px;
      font-size: 1.1rem;
      border-radius: 6px;
      cursor: pointer;
    }

    .blue-btn:hover {
      background-color: #0056b3;
    }

    #result {
      margin-top: 20px;
      font-size: 1rem;
      color: #333;
    }
  </style>
</head>
<body>
  <h2>â€˜í•¨ê»˜ ë””ìì¸í•˜ëŠ” í¬ìš©: ì‹¤ì²œì„ í†µí•œ ë³€í™”â€™<br />ë‚´ê°€ í¬ìš©í•  ìˆ˜ ìˆëŠ” ì‹¤ì²œ ëª©í‘œ ì •í•˜ê¸°</h2>

<div id="options" style="text-align: left; margin: 15px auto; max-width: 300px;">
  <label><input type="radio" name="textOption" value="ë²„ë ¤ì§„ ê²ƒì˜ ì•„ë¦„ë‹¤ì›€ ë°œê²¬í•˜ê¸°" data-id="a" /> ë²„ë ¤ì§„ ê²ƒì˜ ì•„ë¦„ë‹¤ì›€ ë°œê²¬í•˜ê¸°</label>
<label><input type="radio" name="textOption" value="ì“°ì„ì„ ì°¾ì•„ ê³„ì† ì‚¬ìš©í•˜ê¸°" data-id="b" /> ì“°ì„ì„ ì°¾ì•„ ê³„ì† ì‚¬ìš©í•˜ê¸°</label>
<label><input type="radio" name="textOption" value="ë‚˜ì—ê²Œ ë§ê²Œ ë°”ê¾¸ì–´ ë³´ê¸°" data-id="c" /> ë‚˜ì—ê²Œ ë§ê²Œ ë°”ê¾¸ì–´ ë³´ê¸°</label>
<label><input type="radio" name="textOption" value="ì‹ ì²´ì  ì°¨ì´ ë°°ë ¤í•˜ê¸°" data-id="d" /> ì‹ ì²´ì  ì°¨ì´ ë°°ë ¤í•˜ê¸°</label>
<label><input type="radio" name="textOption" value="ì„±ì¥í•˜ëŠ” ëŒ€ìƒ ë³´ì‚´í”¼ê¸°" data-id="e" /> ì„±ì¥í•˜ëŠ” ëŒ€ìƒ ë³´ì‚´í”¼ê¸°</label>
<label><input type="radio" name="textOption" value="ê¸°ìˆ ì— ë”°ë¥¸ í–‰ë™ë³€í™” ì´í•´í•˜ê¸°" data-id="f" /> ê¸°ìˆ ì— ë”°ë¥¸ í–‰ë™ë³€í™” ì´í•´í•˜ê¸°</label>
<label><input type="radio" name="textOption" value="ìµìˆ™í•¨ ê·¹ë³µí•˜ê¸°" data-id="g" /> ìµìˆ™í•¨ ê·¹ë³µí•˜ê¸°</label>
<label><input type="radio" name="textOption" value="ì§€ì†ê°€ëŠ¥ ê³µë™ì²´ ë§Œë“¤ê¸°" data-id="h" /> ì§€ì†ê°€ëŠ¥ ê³µë™ì²´ ë§Œë“¤ê¸°</label>
<label><input type="radio" name="textOption" value="ì¸ê°„ì˜ ë³´í¸ì„± ì¸ì‹í•˜ê¸°" data-id="i" /> ì¸ê°„ì˜ ë³´í¸ì„± ì¸ì‹í•˜ê¸°</label>
</div>
  
  <!-- ìˆ¨ê¸´ íŒŒì¼ ì„ íƒ input -->
  <input type="file" accept="image/*" id="inputImage" />

  <!-- ì‚¬ìš©ì ì¹œí™”ì  ë²„íŠ¼ -->
  <button class="gray-btn" id="customButton">ğŸ“· ì‚¬ì§„ ì„ íƒ</button>
  <br />
  <canvas id="preview" width="300" height="350"></canvas>
  <br />
  <button class="blue-btn" onclick="upload()">ì°¸ì—¬í•˜ê¸°</button>
  <p id="result"></p>

<script>
  const input = document.getElementById('inputImage');
  const canvas = document.getElementById('preview');
  const ctx = canvas.getContext('2d');

  let imageDataUrl = null;
  let originalImageUrl = null;

  // â‘  é€‰é¡¹ID â†’ å›¾æ ‡è·¯å¾„ï¼ˆæŒ‰ä½ çš„ data-id: a~iï¼‰
  const ICONS = {
    a: "./icons/a.png",
    b: "./icons/b.png",
    c: "./icons/c.png",
    d: "./icons/d.png",
    e: "./icons/e.png",
    f: "./icons/f.png",
    g: "./icons/g.png",
    h: "./icons/h.png",
    i: "./icons/i.png",
  };

  // â‘¡ é¢„åŠ è½½å¹¶åšç®€å•ç¼“å­˜ï¼Œé¿å…é‡å¤ä¸‹è½½
  const iconCache = {}; // { id: HTMLImageElement }
  function loadIconById(id) {
    return new Promise((resolve, reject) => {
      if (!id || !ICONS[id]) return resolve(null);
      if (iconCache[id] && iconCache[id].complete) return resolve(iconCache[id]);

      const img = new Image();
      img.crossOrigin = "anonymous"; // è‹¥ä¸å›¾æ ‡åŒåŸŸä¹Ÿæ²¡å…³ç³»
      img.onload = () => {
        iconCache[id] = img;
        resolve(img);
      };
      img.onerror = reject;
      img.src = ICONS[id];
    });
  }

  document.getElementById("customButton").addEventListener("click", () => {
    input.click();
  });

  input.addEventListener('change', async e => {
    const file = e.target.files[0];
    if (!file) return;

    let blob = file;

    if (
      file.type === 'image/heic' || file.type === 'image/heif' ||
      /\.heic$/i.test(file.name)
    ) {
      try {
        document.getElementById("result").innerText = "ğŸ”„ HEIC ë³€í™˜ ì¤‘...";
        blob = await heic2any({
          blob: file,
          toType: 'image/jpeg',
          quality: 0.9
        });
      } catch (err) {
        document.getElementById("result").innerText =
          "âŒ HEIC ë³€í™˜ ì˜¤ë¥˜: " + err.message;
        return;
      }
    }

    const reader = new FileReader();
    reader.onload = async () => {
      originalImageUrl = reader.result;

      // è¯»å–å½“å‰é€‰æ‹©
      const selectedInput = document.querySelector('input[name="textOption"]:checked');
      const selectedText = selectedInput ? selectedInput.value : null;
      const selectedId = selectedInput ? selectedInput.dataset.id : null;

      await renderCanvas(originalImageUrl, selectedText, selectedId);
      imageDataUrl = canvas.toDataURL("image/png");
      document.getElementById("result").innerText = "";
    };
    reader.readAsDataURL(blob);
  });

  // å•é€‰é¡¹æ”¹å˜æ—¶é‡ç»˜
  document.querySelectorAll('input[name="textOption"]').forEach(radio => {
    radio.addEventListener('change', async () => {
      if (!originalImageUrl) return;
      const selectedInput = document.querySelector('input[name="textOption"]:checked');
      const selectedText = selectedInput ? selectedInput.value : null;
      const selectedId = selectedInput ? selectedInput.dataset.id : null;

      await renderCanvas(originalImageUrl, selectedText, selectedId);
      imageDataUrl = canvas.toDataURL("image/png");
    });
  });

  // â‘¢ è´Ÿè´£æŠŠç…§ç‰‡ã€é¡¶éƒ¨è‰²æ¡ã€æ–‡å­—ã€å³ä¸Šè§’å›¾æ ‡éƒ½ç”»ä¸Šå»
  async function renderCanvas(originalUrl, selectedText, selectedId) {
    // å…ˆå¹¶è¡Œå‡†å¤‡åº•å›¾ä¸å›¾æ ‡
    const baseImg = await loadBaseImage(originalUrl);
    const iconImg = selectedId ? await loadIconById(selectedId) : null;

    const side = Math.min(baseImg.width, baseImg.height);
    const sx = (baseImg.width - side) / 2;
    const sy = (baseImg.height - side) / 2;

    canvas.width = 300;
    canvas.height = 350;
    ctx.clearRect(0, 0, 300, 350);

    // åº•å›¾ï¼ˆè£æˆæ­£æ–¹å½¢æ”¾åˆ°ä¸‹æ–¹ 300x300ï¼‰
    ctx.drawImage(baseImg, sx, sy, side, side, 0, 50, 300, 300);

    // é¡¶éƒ¨è‰²æ¡
    const barColor = selectedText ? getColorByText(selectedText) : "#939393";
    ctx.fillStyle = barColor;
    ctx.fillRect(0, 0, 300, 50);

    // æ–‡å­—ï¼ˆæœ‰é€‰é¡¹æ‰ç»˜åˆ¶ï¼‰
    if (selectedText) {
      ctx.font = "bold 20px sans-serif";
      ctx.fillStyle = "rgba(255, 255, 255, 0.9)";
      ctx.textAlign = "right";
      ctx.textBaseline = "middle";
      ctx.fillText(selectedText, 290, 25);
    }

    // å³ä¸Šè§’å›¾æ ‡ï¼ˆæœ‰é€‰é¡¹æ‰ç»˜åˆ¶ï¼‰
    if (iconImg && selectedId) {
      const pad = 0;          // ä¸è¾¹ç¼˜çš„å†…è¾¹è·
      const iconSize = 50;    // ä½ å¯æ”¹ä¸º 48 ç­‰
      const x = pad;
      const y = pad;          // ç”»åœ¨è‰²æ¡å†…
      // å¯é€‰ï¼šåœ¨å›¾æ ‡ä¸‹åŠ ä¸€ç‚¹åŠé€æ˜ç™½åº•ï¼Œæå‡å¯è¯»æ€§
      // ctx.fillStyle = "rgba(255,255,255,0.25)";
      // ctx.fillRect(x - 2, y - 2, iconSize + 4, iconSize + 4);
      ctx.drawImage(iconImg, x, y, iconSize, iconSize);
    }
  }

  function loadBaseImage(src) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = src;
    });
  }

  function getColorByText(text) {
    switch (text) {
      case "ë²„ë ¤ì§„ ê²ƒì˜ ì•„ë¦„ë‹¤ì›€ ë°œê²¬í•˜ê¸°":
        return "#ED40C4";
      case "ì“°ì„ì„ ì°¾ì•„ ê³„ì† ì‚¬ìš©í•˜ê¸°":
        return "#00A400";
      case "ë‚˜ì—ê²Œ ë§ê²Œ ë°”ê¾¸ì–´ ë³´ê¸°":
        return "#FFD700";
      case "ì‹ ì²´ì  ì°¨ì´ ë°°ë ¤í•˜ê¸°":
        return "#22E7AD";
      case "ì„±ì¥í•˜ëŠ” ëŒ€ìƒ ë³´ì‚´í”¼ê¸°":
        return "#7E22C6";
      case "ê¸°ìˆ ì— ë”°ë¥¸ í–‰ë™ë³€í™” ì´í•´í•˜ê¸°":
        return "#2257F3";
      case "ìµìˆ™í•¨ ê·¹ë³µí•˜ê¸°":
        return "#FF8700";
      case "ì§€ì†ê°€ëŠ¥ ê³µë™ì²´ ë§Œë“¤ê¸°":
        return "#E00000";
      case "ì¸ê°„ì˜ ë³´í¸ì„± ì¸ì‹í•˜ê¸°":
        return "#00C3FF";
      default:
        return "#939393";
    }
  }

  function upload() {
    const selectedTextInput = document.querySelector('input[name="textOption"]:checked');
    if (!selectedTextInput) {
      alert("ì‹¤ì²œëª©í‘œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
      return;
    }
    const selectedGoal = selectedTextInput.value;
    const selectedGoalId = selectedTextInput.dataset.id;

    if (!imageDataUrl) {
      alert("ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”.");
      return;
    }

    document.getElementById("result").innerText = "â³ ì—…ë¡œë“œ ì¤‘...";

    const form = new FormData();
    form.append("image", imageDataUrl);
    form.append("goal", selectedGoal);
    form.append("goalId", selectedGoalId);

    fetch("https://script.google.com/macros/s/AKfycbyNzuAX7_clDIKJ4qUpGXo_aXmPveI-ICNRGFSgKheFW4fDJlFDyHSWLfNijqKe82mW/exec", {
      method: "POST",
      body: form
    })
      .then(res => res.text())
      .then(res => {
        document.getElementById("result").innerText = res.includes("SUCCESS")
          ? "âœ… ì—…ë¡œë“œ ì™„ë£Œ!"
          : "âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: " + res;
      })
      .catch(err => {
        document.getElementById("result").innerText = "âŒ ì˜¤ë¥˜ ë°œìƒ: " + err.message;
      });
  }
</script>

