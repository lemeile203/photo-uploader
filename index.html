<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>실천 목표 정하기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/cropperjs"></script>
  <link rel="stylesheet" href="https://unpkg.com/cropperjs/dist/cropper.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #f4f4f4;
      text-align: center;
      padding: 20px;
    }

    h2 {
      color: #333;
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
#options label {
   font-size: 1.1rem;    /* 字号保持不变或可调小为 1rem */
  line-height: 1.2;     /* 行高（选项文本本身的行距）减小 */
  display: block;       
  margin-bottom: 4px;      /* 每个选项间距 */
}
    #preview {
  width: 90vw;
  max-width: 300px;
  height: 350px;
  border: 1px solid #ccc;
  background-color: #fff;
  margin-top: 25px;
    }

    input[type="file"] {
      display: none;
    }

    /* 📷 灰色按钮 */
    .gray-btn {
      margin-top: 15px;
      background-color: #ccc;
      color: #333;
      border: none;
      padding: 8px 12px;
      font-size: 1rem;
      border-radius: 6px;
      cursor: pointer;
    }

    .gray-btn:hover {
      background-color: #bbb;
    }

    /* 📤 蓝色按钮 */
    .blue-btn {
      margin-top: 20px;
      background-color: #007BFF;
      color: white;
      border: none;
      padding: 8px 25px;
      font-size: 1.1rem;
      border-radius: 6px;
      cursor: pointer;
    }

    .blue-btn:hover {
      background-color: #0056b3;
    }

    #result {
      margin-top: 20px;
      font-size: 1rem;
      color: #333;
    }
  </style>
</head>
<body>
  <h2>‘함께 디자인하는 포용: 실천을 통한 변화’<br />내가 포용할 수 있는 실천 목표 정하기</h2>

<div id="options" style="text-align: left; margin: 15px auto; max-width: 300px;">
  <label><input type="radio" name="textOption" value="버려진 것의 아름다움 발견하기" data-id="a" /> 버려진 것의 아름다움 발견하기</label>
<label><input type="radio" name="textOption" value="쓰임을 찾아 계속 사용하기" data-id="b" /> 쓰임을 찾아 계속 사용하기</label>
<label><input type="radio" name="textOption" value="나에게 맞게 바꾸어 보기" data-id="c" /> 나에게 맞게 바꾸어 보기</label>
<label><input type="radio" name="textOption" value="신체적 차이 배려하기" data-id="d" /> 신체적 차이 배려하기</label>
<label><input type="radio" name="textOption" value="성장하는 대상 보살피기" data-id="e" /> 성장하는 대상 보살피기</label>
<label><input type="radio" name="textOption" value="기술에 따른 행동변화 이해하기" data-id="f" /> 기술에 따른 행동변화 이해하기</label>
<label><input type="radio" name="textOption" value="익숙함 극복하기" data-id="g" /> 익숙함 극복하기</label>
<label><input type="radio" name="textOption" value="지속가능 공동체 만들기" data-id="h" /> 지속가능 공동체 만들기</label>
<label><input type="radio" name="textOption" value="인간의 보편성 인식하기" data-id="i" /> 인간의 보편성 인식하기</label>
</div>
 
  
  <!-- 숨긴 파일 선택 input -->
  <input type="file" accept="image/*" id="inputImage" />

  <!-- 사용자 친화적 버튼 -->
  <button class="gray-btn" id="customButton">📷 사진 선택</button>
  <br />
  <canvas id="preview" width="300" height="350"></canvas>
  <br />
  <div style="text-align: center;">
 
   </p>
  <input type="email" placeholder="이메일 주소 (선택사항)"
    style="width: 100%; max-width: 300px; height: 36px;
           font-size: 1.1rem; padding: 6px 10px;
           margin: 4px auto 10px auto;
           border: 1px solid #ccc;
           border-radius: 0;
           box-sizing: border-box;" />
    <p style="margin: 5px 0 4px 0; font-size: 0.7rem; color: #333;">
    이메일을 작성해주시면, 참여하신 사진을 이메일로 보내드립니다.
</div>
  
  <button class="blue-btn" onclick="upload()">참여하기</button>
  <p id="result"></p>

<script>
  const input = document.getElementById('inputImage');
  const canvas = document.getElementById('preview');
  const ctx = canvas.getContext('2d');

  let imageDataUrl = null;
  let originalImageUrl = null;

  // ① 选项ID → 图标路径（按你的 data-id: a~i）
  const ICONS = {
    a: "./icons/a.png",
    b: "./icons/b.png",
    c: "./icons/c.png",
    d: "./icons/d.png",
    e: "./icons/e.png",
    f: "./icons/f.png",
    g: "./icons/g.png",
    h: "./icons/h.png",
    i: "./icons/i.png",
  };

  // ② 预加载并做简单缓存，避免重复下载
  const iconCache = {}; // { id: HTMLImageElement }
  function loadIconById(id) {
    return new Promise((resolve, reject) => {
      if (!id || !ICONS[id]) return resolve(null);
      if (iconCache[id] && iconCache[id].complete) return resolve(iconCache[id]);

      const img = new Image();
      img.crossOrigin = "anonymous"; // 若与图标同域也没关系
      img.onload = () => {
        iconCache[id] = img;
        resolve(img);
      };
      img.onerror = reject;
      img.src = ICONS[id];
    });
  }

  document.getElementById("customButton").addEventListener("click", () => {
    input.click();
  });

  input.addEventListener('change', async e => {
    const file = e.target.files[0];
    if (!file) return;

    let blob = file;

    if (
      file.type === 'image/heic' || file.type === 'image/heif' ||
      /\.heic$/i.test(file.name)
    ) {
      try {
        document.getElementById("result").innerText = "🔄 HEIC 변환 중...";
        blob = await heic2any({
          blob: file,
          toType: 'image/jpeg',
          quality: 0.9
        });
      } catch (err) {
        document.getElementById("result").innerText =
          "❌ HEIC 변환 오류: " + err.message;
        return;
      }
    }

    const reader = new FileReader();
    reader.onload = async () => {
      originalImageUrl = reader.result;

      // 读取当前选择
      const selectedInput = document.querySelector('input[name="textOption"]:checked');
      const selectedText = selectedInput ? selectedInput.value : null;
      const selectedId = selectedInput ? selectedInput.dataset.id : null;

      await renderCanvas(originalImageUrl, selectedText, selectedId);
      imageDataUrl = canvas.toDataURL("image/png");
      document.getElementById("result").innerText = "";
    };
    reader.readAsDataURL(blob);
  });

  // 单选项改变时重绘
  document.querySelectorAll('input[name="textOption"]').forEach(radio => {
    radio.addEventListener('change', async () => {
      if (!originalImageUrl) return;
      const selectedInput = document.querySelector('input[name="textOption"]:checked');
      const selectedText = selectedInput ? selectedInput.value : null;
      const selectedId = selectedInput ? selectedInput.dataset.id : null;

      await renderCanvas(originalImageUrl, selectedText, selectedId);
      imageDataUrl = canvas.toDataURL("image/png");
    });
  });

  // ③ 负责把照片、顶部色条、文字、右上角图标都画上去
  async function renderCanvas(originalUrl, selectedText, selectedId) {
    // 先并行准备底图与图标
    const baseImg = await loadBaseImage(originalUrl);
    const iconImg = selectedId ? await loadIconById(selectedId) : null;

    const side = Math.min(baseImg.width, baseImg.height);
    const sx = (baseImg.width - side) / 2;
    const sy = (baseImg.height - side) / 2;

    canvas.width = 300;
    canvas.height = 350;
    ctx.clearRect(0, 0, 300, 350);

    // 底图（裁成正方形放到下方 300x300）
    ctx.drawImage(baseImg, sx, sy, side, side, 0, 50, 300, 300);

    // 顶部色条
    const barColor = selectedText ? getColorByText(selectedText) : "#939393";
    ctx.fillStyle = barColor;
    ctx.fillRect(0, 0, 300, 50);

    // 文字（有选项才绘制）
    if (selectedText) {
      ctx.font = "bold 20px sans-serif";
      ctx.fillStyle = "rgba(255, 255, 255, 0.9)";
      ctx.textAlign = "right";
      ctx.textBaseline = "middle";
      ctx.fillText(selectedText, 290, 25);
    }

    // 右上角图标（有选项才绘制）
    if (iconImg && selectedId) {
      const pad = 0;          // 与边缘的内边距
      const iconSize = 50;    // 你可改为 48 等
      const x = pad;
      const y = pad;          // 画在色条内
      // 可选：在图标下加一点半透明白底，提升可读性
      // ctx.fillStyle = "rgba(255,255,255,0.25)";
      // ctx.fillRect(x - 2, y - 2, iconSize + 4, iconSize + 4);
      ctx.drawImage(iconImg, x, y, iconSize, iconSize);
    }
  }

  function loadBaseImage(src) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = src;
    });
  }

  function getColorByText(text) {
    switch (text) {
      case "버려진 것의 아름다움 발견하기":
        return "#ED40C4";
      case "쓰임을 찾아 계속 사용하기":
        return "#00A400";
      case "나에게 맞게 바꾸어 보기":
        return "#FFD700";
      case "신체적 차이 배려하기":
        return "#22E7AD";
      case "성장하는 대상 보살피기":
        return "#7E22C6";
      case "기술에 따른 행동변화 이해하기":
        return "#2257F3";
      case "익숙함 극복하기":
        return "#FF8700";
      case "지속가능 공동체 만들기":
        return "#E00000";
      case "인간의 보편성 인식하기":
        return "#00C3FF";
      default:
        return "#939393";
    }
  }

  function upload() {
    const emailInput = document.getElementById("userEmail").value.trim();
form.append("email", emailInput);
    const selectedTextInput = document.querySelector('input[name="textOption"]:checked');
    if (!selectedTextInput) {
      alert("실천목표를 선택하세요.");
      return;
    }
    const selectedGoal = selectedTextInput.value;
    const selectedGoalId = selectedTextInput.dataset.id;

    if (!imageDataUrl) {
      alert("사진을 선택하세요.");
      return;
    }

    document.getElementById("result").innerText = "⏳ 업로드 중...";

    const form = new FormData();
    form.append("image", imageDataUrl);
    form.append("goal", selectedGoal);
    form.append("goalId", selectedGoalId);

    fetch("https://script.google.com/macros/s/AKfycbyNzuAX7_clDIKJ4qUpGXo_aXmPveI-ICNRGFSgKheFW4fDJlFDyHSWLfNijqKe82mW/exec", {
      method: "POST",
      body: form
    })
      .then(res => res.text())
      .then(res => {
        document.getElementById("result").innerText = res.includes("SUCCESS")
          ? "✅ 업로드 완료!"
          : "❌ 업로드 실패: " + res;
      })
      .catch(err => {
        document.getElementById("result").innerText = "❌ 오류 발생: " + err.message;
      });
  }
</script>

